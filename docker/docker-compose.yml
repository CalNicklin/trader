services:
  ib-gateway:
    image: gnzsnz/ib-gateway:latest
    restart: unless-stopped
    ports:
      - "4002:4002"
      - "4004:4004"
      - "5900:5900"
    environment:
      TWS_USERID: ${IBKR_USERNAME}
      TWS_PASSWORD: ${IBKR_PASSWORD}
      TRADING_MODE: ${IBKR_TRADING_MODE:-paper}
      TWS_ACCEPT_INCOMING: "accept"
      READ_ONLY_API: "no"
      VNC_SERVER_PASSWORD: ${VNC_PASSWORD:-changeme}
      EXISTING_SESSION_DETECTED_ACTION: "primaryoverride"
      TWS_COLD_RESTART: "05:00"
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/4004"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 60s
    volumes:
      - ib-gateway-data:/opt/ibgateway

  trader:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    depends_on:
      ib-gateway:
        condition: service_healthy
    environment:
      IBKR_HOST: ib-gateway
      IBKR_PORT: 4004
      IBKR_CLIENT_ID: 1
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      RESEND_API_KEY: ${RESEND_API_KEY}
      ALERT_EMAIL_FROM: ${ALERT_EMAIL_FROM}
      ALERT_EMAIL_TO: ${ALERT_EMAIL_TO}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_REPO_OWNER: ${GITHUB_REPO_OWNER}
      GITHUB_REPO_NAME: ${GITHUB_REPO_NAME:-trader}
      DB_PATH: /app/data/trader.db
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: production
      PAPER_TRADING: ${PAPER_TRADING:-true}
      FMP_API_KEY: ${FMP_API_KEY}
    volumes:
      - trader-data:/app/data

  studio:
    build:
      context: ..
      dockerfile: docker/Dockerfile.studio
    profiles: ["studio"]
    volumes:
      - trader-data:/app/data
    ports:
      - "127.0.0.1:4983:4983"

volumes:
  ib-gateway-data:
  trader-data:
